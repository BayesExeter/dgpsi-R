---
title: "Step function"
output: rmarkdown::html_vignette
description: >
  DGP emulation of a step function.
vignette: >
  %\VignetteIndexEntry{step_fct}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{css}
.badCode {
background-color: red;
}
```

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  eval = FALSE
)
```

This vignette shows how to use the package to emulate a step function with a three-layered DGP structure.

## Load the package

```{r}
library(dgpsi)
init_py()
```

## Set up the step function

```{r}
f <- function(x) {
  if (x < 0.5) return(-1)
  if (x >= 0.5) return(1)
}
```

## Set up training data

```{r}
X <- as.matrix(seq(0, 1, length = 10))
Y <- as.matrix(sapply(X, f))
```

## Set up testing data

```{r}
test_x <- as.matrix(seq(0, 1, length = 200))
test_y <- as.matrix(sapply(test_x, f))
```

## Set up a three-layered DGP structure

```{r}
layer1 <- c(kernel(length = c(1.0), name = 'sexp', nugget = 1e-6))
layer2 <- c(kernel(length = c(1.0), name = 'sexp', nugget = 1e-6))
layer3 <- c(kernel(length = c(1.0), name = 'sexp', nugget = 1e-6, scale_est = TRUE))
all_layer <- combine(layer1, layer2, layer3)
m <- dgp(X, Y, all_layer)
```

## Summarize the untrained model

```{r}
summary(m)
```

```{r, class.source="badCode"}
## +-----------+----------+------------------+-----------------+---------------+-------------------+------------+-------------------+
## | Layer No. | Node No. |       Type       | Length-scale(s) |   Variance    |      Nugget       | Input Dims | Global Connection |
## +-----------+----------+------------------+-----------------+---------------+-------------------+------------+-------------------+
## |  Layer 1  |  Node 1  | GP (Squared-Exp) |     [1.000]     | 1.000 (fixed) | 1.000e-06 (fixed) |    [1]     |        No         |
## |  Layer 2  |  Node 1  | GP (Squared-Exp) |     [1.000]     | 1.000 (fixed) | 1.000e-06 (fixed) |    [1]     |        No         |
## |  Layer 3  |  Node 1  | GP (Squared-Exp) |     [1.000]     |     1.000     | 1.000e-06 (fixed) |    [1]     |        No         |
## +-----------+----------+------------------+-----------------+---------------+-------------------+------------+-------------------+
## 1. 'Input Dims' presents the indices of GP nodes in the feeding layer whose outputs are used as the input to the current GP.
## 2. 'Global Connection' indicates the dimensions (i.e., column numbers) of the global input data that are used as additional input dimensions ## to the current GP.
```

## Train the model

```{r}
m_trained <- train(m)

## Iteration 500: Layer 3: 100%|██████████| 500/500 [00:04<00:00, 106.14it/s]
```

## Construct the emulator

```{r}
trained_struc=estimate(m_trained)
emu <- emulator(trained_struc)
```

## Summarize the trained model for emulation

```{r}
summary(emu)

## ╒═════════════╤════════════╤══════════════════╤═══════════════════╤═══════════════╤═══════════════════╤══════════════╤═════════════════════╕
## │ Layer No.   │ Node No.   │ Type             │ Length-scale(s)   │ Variance      │ Nugget            │ Input Dims   │ Global Connection   │
## ╞═════════════╪════════════╪══════════════════╪═══════════════════╪═══════════════╪═══════════════════╪══════════════╪═════════════════════╡
## │ Layer 1     │ Node 1     │ GP (Squared-Exp) │ [0.535]           │ 1.000 (fixed) │ 1.000e-06 (fixed) │ [1]          │ No                  │
## ├─────────────┼────────────┼──────────────────┼───────────────────┼───────────────┼───────────────────┼──────────────┼─────────────────────┤
## │ Layer 2     │ Node 1     │ GP (Squared-Exp) │ [0.957]           │ 1.000 (fixed) │ 1.000e-06 (fixed) │ [1]          │ No                  │
## ├─────────────┼────────────┼──────────────────┼───────────────────┼───────────────┼───────────────────┼──────────────┼─────────────────────┤
## │ Layer 3     │ Node 1     │ GP (Squared-Exp) │ [0.953]           │ 0.307         │ 1.000e-06 (fixed) │ [1]          │ No                  │
## ╘═════════════╧════════════╧══════════════════╧═══════════════════╧═══════════════╧═══════════════════╧══════════════╧═════════════════════╛
## 1. 'Input Dims' presents the indices of GP nodes in the feeding layer whose outputs are used as the input to the current GP.
## 2. 'Global Connection' indicates the dimensions (i.e., column numbers) of the global input data that are used as additional input dimensions to the current GP.
```

## Make predictions

```{r}
res <- predict(emu, x = test_x)
```

## Plot the emulation results

```{r}
mu <- res$mean
sd <- sqrt(res$var)
up <- mu + 2*sd
lo <- mu - 2*sd

plot(test_x, mu, type='l',col='blue',xlab='x', cex.axis=1.3,cex.lab=1.3, ylab='y',ylim=c(-1.5,1.5))
polygon(c(test_x,rev(test_x)),c(up,rev(lo)),col='grey80',border=F)
lines(test_x,mu,type='l',col='blue')
lines(test_x,test_y,type='l',col='red')
lines(X,Y,type='p',cex=0.8)
```

![](images/step_fct.png)
